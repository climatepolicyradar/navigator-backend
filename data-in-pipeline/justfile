dev: uv run python -m app.dev

test: uv run pytest -vv

test-ci:
    #!/usr/bin/env bash
    # Build and test against the Docker image
    set -euxo pipefail
    docker build -t data-in-pipeline:test -f Dockerfile ..
    docker run --rm data-in-pipeline:test uv run pytest -vv

deploy-to-prefect-from-local:
    #!/usr/bin/env bash
    # we use a bash script here to have inline env variables
    # @see: https://just.systems/man/en/setting-variables-in-a-recipe.html
    set -euxo pipefail
    AWS_ACCOUNT_ID=$(aws sts get-caller-identity --query 'Account' --output text)
    DOCKER_REGISTRY="${AWS_ACCOUNT_ID}.dkr.ecr.eu-west-1.amazonaws.com"
    uv run prefect cloud login
    DOCKER_REGISTRY=${DOCKER_REGISTRY} just deploy-to-prefect

deploy-to-prefect: uv run python -m app.deploy

# DuckDB to serve transformation results
# This is currently a spike to be able to better analyse, validate and share with others how the transformations are working
duckdb-build: uv run python -m app.scripts.build_duckdb

duckdb-dev: uv run fastapi dev ./app/scripts/serve_duckdb.py

# Commands for our IAM user lambda function
build-lambda-code: clean-lambda-build-folder
    set -e
    mkdir -p .lambda_build
    echo "üê≥ Building Lambda package with Docker..."
    docker build --platform linux/amd64 -f infra/Dockerfile -t iam-user-lambda-builder .
    echo "üì¶ Extracting built package..."
    docker create --name iam-user-lambda-extract iam-user-lambda-builder
    docker cp iam-user-lambda-extract:/build/. .lambda_build/
    docker rm iam-user-lambda-extract
    echo "‚úÖ Lambda package built at .lambda_build/"

clean-lambda-build-folder: echo "üßπ Cleaning build directory..."
    rm -rf .lambda_build

deploy-lambda-code: build-lambda-code
    pulumi up -ry

build-load-api: docker build --tag load-api --platform="linux/amd64" .
