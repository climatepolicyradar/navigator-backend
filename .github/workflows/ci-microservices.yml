# This workflow **only** includes our microservices
# ci-cd.yml controls the backend-api app
name: CI for microservices
on:
  pull_request:
    # there is a micro-optimisation here in only running test if it's a relevant label
    # but this isn't currently a performance bottleneck so we're leaving it to run on all labels to reduce complexity
    # a. deploys the service to staging if the pull request is (re)labelled with 'deploy:staging'
    types: [opened, synchronize, reopened, labeled] # This needs to be the American spelling, don't change it
    paths:
      - "!backend-api/**"
      - "**"
  workflow_dispatch: {}

permissions:
  id-token: write
  contents: read

jobs:
  determine-changed-services:
    runs-on: ubuntu-latest
    outputs:
      microservices: ${{ steps.services.outputs.microservices }}
      data-in-pipeline: ${{ steps.services.outputs.data-in-pipeline }}
    steps:
      - uses: actions/checkout@v6
      - uses: dorny/paths-filter@v3
        id: changes
        with:
          filters: |
            families-api:
              - families-api/**
              - api/**

            geographies-api:
              - geographies-api/**
              - api/**

            concepts-api:
              - concepts-api/**
              - api/**

            data-in-pipeline:
              - data-in-pipeline/**
              - api/**

      - id: services
        run: |
          MICROSERVICES=()
          DATA_IN_PIPELINE=false
          if [ "${{ steps.changes.outputs.families-api }}" == "true" ]; then
            MICROSERVICES+=("families-api")
          fi
          if [ "${{ steps.changes.outputs.geographies-api }}" == "true" ]; then
            MICROSERVICES+=("geographies-api")
          fi
          if [ "${{ steps.changes.outputs.concepts-api }}" == "true" ]; then
            MICROSERVICES+=("concepts-api")
          fi
          if [ "${{ steps.changes.outputs.data-in-pipeline }}" == "true" ]; then
            DATA_IN_PIPELINE=true
          fi

          # If no services detected but workflow was triggered (changes outside backend-api),
          # assume root-level changes and trigger all services as a safety measure
          if [ ${#MICROSERVICES[@]} -eq 0 ] && [ "$DATA_IN_PIPELINE" == "false" ]; then
            MICROSERVICES+=("families-api" "geographies-api" "concepts-api")
            DATA_IN_PIPELINE=true
            echo "No specific services changes detected, but workflow was triggered - assuming root-level changes, triggering all services"
          fi

          echo "microservices=$(jq -c -n '$ARGS.positional' --args "${MICROSERVICES[@]}")" >> $GITHUB_OUTPUT
          echo "data-in-pipeline=$DATA_IN_PIPELINE" >> $GITHUB_OUTPUT
          echo "Changed microservices: ${MICROSERVICES[@]}"

  test-microservices:
    needs: determine-changed-services
    if: needs.determine-changed-services.outputs.microservices != '[]'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: ${{ fromJSON(needs.determine-changed-services.outputs.microservices) }}
    steps:
      - uses: actions/checkout@v6
      - uses: extractions/setup-just@v3
      - run: just test ${{ matrix.service }}

  test-data-in-pipeline:
    needs: determine-changed-services
    if: needs.determine-changed-services.outputs.data-in-pipeline == 'true'
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: data-in-pipeline
    steps:
      - uses: actions/checkout@v6
      - uses: extractions/setup-just@v3
      - run: just test-ci

  deploy-feature-branch:
    needs: [test-microservices, determine-changed-services]
    # a. deploys the service to staging if the pull request is (re)labelled with 'deploy:staging'
    if: contains(github.event.pull_request.labels.*.name, 'deploy:staging') && needs.determine-changed-services.outputs.microservices != '[]'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        environment: [staging]
        service: ${{ fromJSON(needs.determine-changed-services.outputs.microservices) }}
    environment: ${{ matrix.environment }}
    steps:
      - uses: actions/checkout@v6
      - uses: extractions/setup-just@v3
      - uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/navigator-backend-github-actions-deploy
          role-session-name: GitHub_to_AWS_via_FederatedOIDC_${{ matrix.environment }}
          aws-region: eu-west-1
      - uses: aws-actions/amazon-ecr-login@v2
      # we use python / uv in some build scripts and testing
      - uses: actions/setup-python@v6
        with:
          python-version: "3.12"
      - uses: astral-sh/setup-uv@v7
      - run: uv sync --all-packages
      - run: just deploy ${{ matrix.service }} ${{ matrix.environment }} latest
